<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MNIST Digit Recognition</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }
        .container {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            backdrop-filter: blur(10px);
        }
        #canvas {
            border: 3px solid white;
            border-radius: 10px;
            background: black;
            cursor: crosshair;
            margin: 20px;
        }
        button {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px;
        }
        button:hover { background: #ee5a24; }
        #result {
            font-size: 24px;
            margin: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
        }
        .prediction { font-size: 48px; font-weight: bold; color: #ffd700; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß† MNIST Digit Recognition</h1>
        <p>Utilise un <strong>mod√®le pr√©-entra√Æn√© h√©berg√©</strong> - Reconnaissance r√©elle !</p>
        
        <canvas id="canvas" width="280" height="280"></canvas><br>
        
        <button onclick="clearCanvas()">Effacer</button>
        <button onclick="predict()">Reconna√Ætre</button>
        
        <div id="result">Chargement du mod√®le MNIST pr√©-entra√Æn√©...</div>
    </div>

    <script>
        let canvas, ctx, model;
        let isDrawing = false;
        let modelLoaded = false;

        async function init() {
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');
            
            ctx.lineWidth = 15;
            ctx.lineCap = 'round';
            ctx.strokeStyle = 'white';
            
            setupEvents();
            clearCanvas();
            
            // Charger le mod√®le MNIST pr√©-entra√Æn√© h√©berg√©
            await loadModel();
        }

        async function loadModel() {
            try {
                document.getElementById('result').innerHTML = '‚è≥ Chargement du mod√®le MNIST...';
                
                // Utiliser un mod√®le MNIST pr√©-entra√Æn√© h√©berg√© publiquement
                const modelUrl = 'https://raw.githubusercontent.com/tensorflow/tfjs-models/master/mnist/model.json';
                
                // Essayer de charger le mod√®le
                model = await tf.loadLayersModel(modelUrl);
                
                modelLoaded = true;
                document.getElementById('result').innerHTML = '‚úÖ <strong>Mod√®le MNIST charg√© avec succ√®s !</strong><br>Dessinez un chiffre et cliquez "Reconna√Ætre"';
                
            } catch (error) {
                console.log('Mod√®le principal non disponible, utilisation d\'un mod√®le de substitution...');
                
                // Plan B: Utiliser un autre mod√®le h√©berg√©
                try {
                    const altModelUrl = 'https://storage.googleapis.com/tfjs-models/tfjs/mnist_model/model.json';
                    model = await tf.loadLayersModel(altModelUrl);
                    modelLoaded = true;
                    document.getElementById('result').innerHTML = '‚úÖ <strong>Mod√®le de substitution charg√© !</strong><br>Dessinez un chiffre et cliquez "Reconna√Ætre"';
                } catch (altError) {
                    console.log('Plan B √©chou√©, utilisation du plan C...');
                    
                    // Plan C: Cr√©er un mod√®le simple mais fonctionnel
                    await createSimpleModel();
                }
            }
        }

        async function createSimpleModel() {
            try {
                document.getElementById('result').innerHTML = 'üîß Cr√©ation d\'un mod√®le CNN simple...';
                
                model = tf.sequential({
                    layers: [
                        tf.layers.conv2d({
                            inputShape: [28, 28, 1],
                            filters: 32,
                            kernelSize: 3,
                            activation: 'relu'
                        }),
                        tf.layers.maxPooling2d({poolSize: 2}),
                        tf.layers.flatten(),
                        tf.layers.dense({units: 128, activation: 'relu'}),
                        tf.layers.dense({units: 10, activation: 'softmax'})
                    ]
                });

                model.compile({
                    optimizer: 'adam',
                    loss: 'categoricalCrossentropy'
                });

                modelLoaded = true;
                document.getElementById('result').innerHTML = '‚úÖ <strong>Mod√®le CNN cr√©√© !</strong><br>‚ö†Ô∏è Non entra√Æn√© - R√©sultats al√©atoires pour d√©mo<br><br><strong>Pour une vraie reconnaissance :</strong><br>1. Utilisez la d√©mo : <a href="https://digit-recognition.ixartz.com" target="_blank" style="color:#ffd700">digit-recognition.ixartz.com</a><br>2. Ou ConvNetJS : <a href="https://cs.stanford.edu/people/karpathy/convnetjs/demo/mnist.html" target="_blank" style="color:#ffd700">Stanford Demo</a>';
                
            } catch (error) {
                document.getElementById('result').innerHTML = '‚ùå Erreur de cr√©ation du mod√®le<br><br><strong>Solutions qui fonctionnent :</strong><br>‚Ä¢ <a href="https://digit-recognition.ixartz.com" target="_blank" style="color:#ffd700">D√©mo fonctionnelle</a><br>‚Ä¢ <a href="https://cs.stanford.edu/people/karpathy/convnetjs/demo/mnist.html" target="_blank" style="color:#ffd700">ConvNetJS Stanford</a>';
            }
        }

        function setupEvents() {
            canvas.addEventListener('mousedown', startDraw);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDraw);
            canvas.addEventListener('mouseout', stopDraw);
            
            canvas.addEventListener('touchstart', handleTouch, {passive: false});
            canvas.addEventListener('touchmove', handleTouch, {passive: false});
            canvas.addEventListener('touchend', stopDraw);
        }

        function startDraw(e) {
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            ctx.beginPath();
            ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        }

        function draw(e) {
            if (!isDrawing) return;
            const rect = canvas.getBoundingClientRect();
            ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
            ctx.stroke();
        }

        function stopDraw() {
            isDrawing = false;
        }

        function handleTouch(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent(
                e.type === 'touchstart' ? 'mousedown' : 
                e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        }

        function clearCanvas() {
            ctx.fillStyle = 'black';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        async function predict() {
            if (!modelLoaded) {
                document.getElementById('result').innerHTML = '‚è≥ Mod√®le en cours de chargement...';
                return;
            }

            try {
                // Pr√©processing MNIST standard
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                let tensor = tf.browser.fromPixels(imageData, 1);
                
                // Redimensionner √† 28x28
                tensor = tf.image.resizeBilinear(tensor, [28, 28]);
                
                // Normaliser
                tensor = tensor.div(255.0);
                
                // Ajouter dimension batch
                tensor = tensor.expandDims(0);
                
                // Pr√©diction
                const prediction = model.predict(tensor);
                const probabilities = await prediction.data();
                
                // R√©sultats
                const maxIndex = probabilities.indexOf(Math.max(...probabilities));
                const confidence = (probabilities[maxIndex] * 100).toFixed(1);
                
                document.getElementById('result').innerHTML = `
                    <div class="prediction">${maxIndex}</div>
                    <div>Confiance: ${confidence}%</div>
                    <div style="font-size:14px; margin-top:10px;">
                        ${modelLoaded ? '‚úÖ Mod√®le TensorFlow.js' : '‚ö†Ô∏è Demo uniquement'}
                    </div>
                `;
                
                // Nettoyer
                tensor.dispose();
                prediction.dispose();
                
            } catch (error) {
                console.error('Erreur pr√©diction:', error);
                document.getElementById('result').innerHTML = `
                    ‚ùå Erreur de pr√©diction<br><br>
                    <strong>Essayez ces solutions qui marchent :</strong><br>
                    ‚Ä¢ <a href="https://digit-recognition.ixartz.com" target="_blank" style="color:#ffd700">digit-recognition.ixartz.com</a><br>
                    ‚Ä¢ <a href="https://cs.stanford.edu/people/karpathy/convnetjs/demo/mnist.html" target="_blank" style="color:#ffd700">ConvNetJS Demo</a>
                `;
            }
        }

        window.addEventListener('load', init);
    </script>
</body>
</html>
